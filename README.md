<a name="TOP"></a>
![picture alt](https://placehold.co/1000x100/transparent/999?text=Markdown%20Cheatsheet&font=source-sans-pro "Leo Transformer")

# ğŸ“ å†™åœ¨å‰é¢

è¿™æ˜¯ä¸€ä¸ªè‡ªå­¦ transformer çš„è®°å½•ã€‚æœ‰ä¸ªäººçš„é€è¡Œæ³¨é‡Šä¸è‡ªæˆ‘ç†è§£ï¼Œåˆ†äº«ä¾›å¤§å®¶å‚è€ƒäº¤æµã€‚
è¿™é‡Œå®ç°çš„æ˜¯ transformer æœ€æœ¬æ¥çš„ç”¨é€”â€”â€”ç¿»è¯‘ï¼šè‹±è¯­ -> ä¸­æ–‡

# å¿«é€Ÿå¼€å§‹

ç¯å¢ƒå®‰è£… :

    # åˆ›å»º conda ç¯å¢ƒ
    conda create -n leo-transformer python=3.10 -y && conda activate leo-transformer

    # å®‰è£… torch
    # ä¸è®ºæ˜¯ conda å®‰è£…è¿˜æ˜¯ pip å®‰è£… torchï¼Œéƒ½ä¸éœ€è¦é‡å¤æ‰‹åŠ¨åœ¨å…¨å±€ä¸­è‡ªå·±æ›´æ–° cuda ç‰ˆæœ¬
    # torch æºå¸¦äº†å·²ç»ç¼–è¯‘å¥½çš„ cuda å†…å®¹
    pip install torch==1.12.1+cu113 torchvision==0.13.1+cu113 torchaudio==0.12.1 --extra-index-url https://download.pytorch.org/whl/cu113

    # å®‰è£…ä¾èµ–
    cd leo_transformer
    pip install -r requirements.txt

    # è¿›è¡Œç¿»è¯‘ä»»åŠ¡æ£€æµ‹ç¯å¢ƒæ˜¯å¦æˆåŠŸå®‰è£…
    # è¿™é‡Œåªè¦æ²¡æœ‰æŠ¥é”™å³å¯ï¼Œè¿™é‡Œè¿˜æ²¡æœ‰æ¨¡å‹æ‰€ä»¥æ²¡åŠæ³•è¿›è¡Œç¿»è¯‘ä»»åŠ¡
    python use_model_2_translate.py


# æ•°æ®é›†å‡†å¤‡

åŸå§‹æ•°æ®é›†ä¸º .json æ–‡ä»¶æ ¼å¼ï¼Œæ¯ä¸ª .json æ–‡ä»¶çš„æ ¼å¼æ˜¯ç›¸åŒçš„ï¼Œä½†å†…å®¹äº’ç›¸ç‹¬ç«‹
åˆ†ä¸ºï¼štrain.json(è®­ç»ƒæ•°æ®é›†) val.json(è®­ç»ƒä¸­è¯„ä¼°æ•°æ®é›†) test.json(è®­ç»ƒåéªŒè¯æ•°æ®é›†)

.json æ–‡ä»¶ä»¥ [["éœ€è¦è¢«ç¿»è¯‘çš„æºè¯­è¨€å¥å­", "å¯¹åº”ç¿»è¯‘åçš„ç›®æ ‡è¯­è¨€å¥å­"]ï¼Œ ["éœ€è¦è¢«ç¿»è¯‘çš„æºè¯­è¨€å¥å­", "å¯¹åº”ç¿»è¯‘åçš„ç›®æ ‡è¯­è¨€å¥å­"]ï¼Œ ... , ["éœ€è¦è¢«ç¿»è¯‘çš„æºè¯­è¨€å¥å­", "å¯¹åº”ç¿»è¯‘åçš„ç›®æ ‡è¯­è¨€å¥å­"]]

tips:
åªæ˜¯æƒ³è·‘é€šæµç¨‹ï¼Œå¯ä»¥ä½¿ç”¨éšæ„çš„ aiï¼ŒæŠŠè¦æ±‚å’Œæ ¼å¼ç»™ä»–å¹¶è®©ä»–æŠŠè¾“å‡ºåŒ…è£¹åœ¨ä»£ç æ¡†ä¸­ï¼Œä»–å¯ä»¥ç›´æ¥è¾“å‡º .json æ ¼å¼çš„å†…å®¹ã€‚

ä»¥ train.json ä¸ºä¾‹:
[["Military leaders know this, and the threat that they will eventually push him aside will plague his presidency well into next year.", "åœ¨æ‹…ä»»æ€»ç†å–å¾—å®æƒåï¼Œå¥¹æœ€ç»ˆå¯èƒ½ä¼šé‡æ–°å®¡è§†å¥¹ä¸ç©†æ²™æ‹‰å¤«çš„åè®®ã€‚"], ...]

# å¼€å§‹è®­ç»ƒ

è®­ç»ƒæŒ‡ä»¤ï¼š

    # 1. å‡†å¤‡å¥½train.json(è®­ç»ƒæ•°æ®é›†) val.json(è®­ç»ƒä¸­è¯„ä¼°æ•°æ®é›†) test.json(è®­ç»ƒåéªŒè¯æ•°æ®é›†)

    # 2. æ ¹æ®æ•°æ®é›†åˆ›å»º corpus
    cd leo_transfomer
    python translation_en_zh/get_corpus_txt.py

    # 3. æ ¹æ® corpus åˆ›å»ºåŒè¯­è¨€çš„ tokenizer
    python tokenizer/tokenization.py

    # 4. è¿è¡Œè®­ç»ƒä¸»ç¨‹åº
    python train.py

# ç»“æ„ä»‹ç»

## translation_en_zh

æ•°æ®å¤„ç†

### json_unicode_preview.py

ç›´æ¥åœ¨ ide ä¸­æŸ¥çœ‹è‹±æ–‡ä»¥å¤–çš„æ–‡æœ¬å¯èƒ½æ˜¯ä¹±ç ï¼Œè¿™ä¸ªæ–‡ä»¶ç”¨äºè¯»å–æŸ¥çœ‹ .json æ–‡ä»¶æ˜¯å¦ç¬¦åˆé¢„æœŸ

### get_corpus_txt.py

åˆ©ç”¨ .json æ–‡ä»¶ï¼ˆåŒ…å« train, val, test ä¸­çš„æ‰€æœ‰æ•°æ®ï¼‰ç”Ÿæˆ çº¯æºè¯­è¨€è¯­æ–™åº“ã€çº¯ç¿»è¯‘ç›®æ ‡è¯­è¨€è¯­æ–™åº“ã€‚è¿™ä¸¤ä¸ªåˆ—è¡¨ç”¨äº è¯è¡¨ çš„ç”Ÿæˆ

### analyze_corpus.py

ç”¨äºç»Ÿè®¡ get_corpus_txt äº§ç”Ÿçš„ corpus æ˜¯å¦æ­£ç¡®è¿›è¡Œäº†å¯¹åº”ï¼Œç”¨äºå¿«é€ŸæŸ¥çœ‹ corpus çš„ç”Ÿæˆæ˜¯å¦æ­£ç¡®

## tokenizer

tokenizer å®ç°

### tokenization.py

æ ¹æ®ä¸Šè¿°çš„ corpus åˆ†åˆ«äº§ç”Ÿ æºè¯­è¨€ tokenizerã€ç›®æ ‡è¯­è¨€ tokenizer

.model æ–‡ä»¶æ˜¯åœ¨ä¹‹åä»£ç ä¸­ä½¿ç”¨çš„ tokenizer
.vocab æ–‡ä»¶æ˜¯ä¾›äººæŸ¥çœ‹çš„å¯è§†åŒ–æ–‡ä»¶ï¼Œä¸å‚ä¸ä»£ç è¿è¡Œ

## model_codes

model å®ç°

### transformer_model.py

transformer çš„ encoder å’Œ decoder éƒ½æ˜¯é‡å¤å¾ªç¯å¤šæ¬¡çš„ï¼Œå…ˆå®šä¹‰ clones å‡½æ•°ä¾¿äºåœ¨ç½‘ç»œè¿æ¥çš„æ—¶å€™ä¾¿æ·å¿«é€Ÿåˆ›å»ºå¤šä¸ªç›¸åŒçš„ç½‘ç»œå—

tipsï¼š

1. embeddings å±‚å®é™…ä¸Šç­‰æ•ˆäºä¸€ä¸ª self.weight = torch.randn(vocab_size, d_token_embedding) çš„æ²¡æœ‰åç½®çš„ vovab_size -> d_token_embedding çš„å…¨è¿æ¥å±‚ã€‚ä½†æ˜¯å…¨è¿æ¥å±‚æ˜¯çŸ©é˜µä¹˜æ³•ï¼Œè€Œè¯åµŒå…¥çŸ©é˜µæ˜¯ç›´æ¥ç´¢å¼•ï¼ˆå› ä¸ºè¾“å…¥çš„è¯è¡¨ç´¢å¼•æœ¬èº«å°±æ˜¯ç‹¬çƒ­ç¼–ç ï¼Œvocab_sizeç»´åº¦ä¸­åªæœ‰ä¸€ä¸ª1ï¼Œå…¶ä½™ä¸º0ï¼‰ï¼Œå› æ­¤è¯åµŒå…¥çŸ©é˜µçš„è®¡ç®—æ•ˆç‡æ›´é«˜

2. å•ç‹¬å®šä¹‰ def attention ç”¨äºç‹¬ç«‹è®¡ç®—ä¼ å…¥çš„ Q K V çš„ç»Ÿä¸€çŸ©é˜µä¹˜æ³•æ“ä½œï¼Œä¾¿äºå¤ç”¨

3. åŸæ–‡ï¼šä¸€ä¸ªæ®‹å·®è¿æ¥å—çš„æµç¨‹ä¸ºï¼š x -> attention(æˆ–è€… FFN) -> dropout -> add(æ®‹å·®) -> norm

4. åŸæ–‡ä¸­ï¼Œencoderã€decoder å‡ä¸ºå…­å±‚é‡å¤ç»“æ„ï¼Œä½†æ˜¯ decoder ä¸­çš„ cross attention çš„æ¥è‡ª encoder çš„è¾“å…¥ï¼Œåªä½¿ç”¨äº†å…­å±‚ encoder çš„æœ€åä¸€å±‚è¾“å‡ºï¼Œè¾“å…¥ç»™åç»­çš„å…­å±‚ä¸­çš„æ¯ä¸€å±‚çš„ decoderã€‚è¿™åªæ˜¯ä»£ç å®ç°çš„ä¾¿åˆ©ï¼šæ²¡æœ‰ä¿å­˜å‰ç½®å±‚çš„ encoder ä¸­é—´è¾“å‡ºï¼Œä¸”æ¯å±‚çš„ decoder ä½¿ç”¨ç›¸åŒçš„è¾“å…¥ã€‚åç»­å¯ä»¥å°è¯•ä¸åŒçš„ encoder decoder çš„è¿æ¥æ–¹å¼ã€‚

5. å®Œæ•´çš„ transformer ä¼ æ’­è·¯å¾„åœ¨ generator è¿‡ç¨‹æ–­å¼€äº†ï¼Œè¿‘ä¼ é€’åˆ°æœ€åä¸€å±‚ decoder å°±åœæ­¢ã€‚è¿™æ˜¯å› ä¸º generator æ˜¯ä¸€ä¸ªå°ºå¯¸å·¨å¤§çš„å…¨è¿æ¥ nn.Linear(d_token_embedding, vocab_size), åç»­ä¸ºäº†æ‰‹åŠ¨å®ç° batch å†…åˆ†å—æ¢¯åº¦ç´¯è®¡å‡å°‘å³°å€¼æ˜¾å­˜éœ€æ±‚ï¼Œä¸é€‚åˆç›´æ¥è‡ªåŠ¨å‰å‘ä¼ æ’­ä¸åå‘ä¼ æ’­ã€‚

6. generator çš„è¾“å‡ºæ˜¯ç›´æ¥è¾“å‡ºï¼Œè€Œä¸èƒ½è¿›è¡Œ log_softmaxã€‚å› ä¸ºåç»­ loss è®¡ç®—çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯å®˜æ–¹æ¨èçš„ nn.CrossEntropyLoss()ï¼Œå…¶åº“ä¸­çš„æ³¨é‡Šå’Œå…·ä½“ä»£ç å®ç°ç¡®å®æ˜¯ä¼šå…ˆè¿›è¡Œä¸€æ¬¡ log_softmaxã€‚å¦‚æœè‡ªå·±å…ˆæ‰‹åŠ¨è¿›è¡Œä¸€æ¬¡ï¼Œé‚£ä¹ˆæ•°å€¼ä¼šå˜å¾—è¿‡å°å¯¼è‡´ loss ä¸€ç›´æ˜¯ NANã€‚å®˜æ–¹æ¨èä½¿ç”¨ nn.CrossEntropyLoss() è€Œä¸æ˜¯æ‰‹åŠ¨ log_softmax + F.nll_lossã€‚å› ä¸ºCrossEntropyLoss å†…éƒ¨ä½¿ç”¨äº† log-sum-exp trickï¼Œé¿å…æ•°å€¼æº¢å‡ºï¼Œä¸”æ‰‹åŠ¨åˆ†ç¦»è®¡ç®—æ—¶ï¼Œä¸­é—´ç»“æœéœ€è¦é¢å¤–å†…å­˜å­˜å‚¨

7. å°è¯•ä¸åŒé¡ºåºçš„æ®‹å·®è¿æ¥
ç›¸åŒå‚æ•°ï¼Œè®­ç»ƒ 10 epoch ï¼š 
x = x + self.norm(self.dropout(sublayer(x))) BLEU 6.13  æˆ‘
x = x + self.dropout(sublayer(self.norm(x))) BLEU 25.34 pre-norm
x = self.norm(x + self.dropout(sublayer(x))) BLEU 1.62  post-norm (åŸæ–‡)
æˆ‘çš„ä¼˜åŒ–æƒ³æ³•æ˜¯ç†è®ºä¸Šæ¥è¯´ï¼Œæ®‹å·®è¿æ¥æ˜¯ä¸ºäº†è®©åå‘ä¼ æ’­æ›´å¥½çš„è·¨è¶Šåˆ°è¾“å…¥å±‚ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºè¦é¿å… norm å¯¹äºè¾“å…¥çš„å¹²æ‰°ï¼Œä½†å®é™…ä¸Šç†è§£é”™è¯¯äº†
æ®‹å·®è¿æ¥æ˜¯ä¸ºäº†è®©åå‘ä¼ æ’­æ›´å¥½çš„è·¨è¶Šåˆ°è¾“å…¥å±‚ï¼Œé‚£ä¹ˆæ›´åº”è¯¥åŒæ—¶è®© x è¿™éƒ¨åˆ†ä¹Ÿè¢« normã€‚å½“æ®‹å·®ç¡®å®å‘æŒ¥ä½œç”¨çš„æ—¶å€™ï¼Œé‚£ä¹ˆæ„å‘³ç€è¿™ä¸€å±‚ç½‘ç»œæ˜¯å¤±è´¥çš„æƒé‡æå°éœ€è¦ç»•è¿‡ï¼Œé‚£ä¹ˆå¦‚æœ x æ²¡æœ‰è¢« normï¼Œé‚£ä¹ˆæ¶æ„å°±å‘ç”Ÿäº†æ”¹å˜äº†ã€‚å¹¶ä¸”ï¼Œä¸€èµ·normå¹¶ä¸å½±å“æ®‹å·®è¿æ¥æ˜¯ä¸ºäº†è®©åå‘ä¼ æ’­æ›´å¥½çš„è·¨è¶Šåˆ°è¾“å…¥å±‚è¿™ä¸€æœ¬è´¨ï¼Œå› ä¸º norm å¯ä»¥çœ‹ä½œæ˜¯ä¸‹ä¸€å±‚çš„è¾“å…¥ï¼Œè¿™æ—¢æ˜¯ pre-norm
pre-norm å’Œ post-norm çš„æ€§èƒ½å·®å¼‚å·¨å¤§ã€‚pre-norm å’Œ post-norm å¦‚æœåœ¨å¤šå±‚ç½‘ç»œæ¶æ„ä¸­çœ‹å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆä»–ä»¬ä¼šæ˜¯å®Œå…¨ä¸€æ ·çš„ã€‚å”¯ä¸€çš„åŒºåˆ«åªåœ¨ pre-norm åœ¨æœ€å¼€å¤´çš„æ—¶å€™å…ˆ norm äº† inputï¼Œè€Œ post-norm æ²¡æœ‰ï¼Œè®© input ç›´æ¥è¿›æ¥ï¼›è€Œ pre-norm ç›´æ¥è¾“å‡ºæ®‹å·®è¿æ¥ç»™ generatorï¼Œè€Œ post-norm ç»è¿‡ norm åå†è¾“å‡ºç»™ generatorã€‚å³ä½¿å­˜åœ¨æ€§èƒ½å·®è·ä¹Ÿå¹¶æ²¡æœ‰å¯è§£é‡Šæ€§ã€‚
æ¬¢è¿å„ä½å¤§ä½¬å‘Šè¯‰æˆ‘è¿™é‡Œé¢çš„æ·±å±‚åŸå› 

## utils

æ‰€æœ‰éœ€è¦åˆ°çš„å·¥å…·æ–‡ä»¶

### config.py

ç”¨äºåŠ è½½ config/config.yaml é…ç½®å‚æ•°

### create_exp_folder.py

ç”¨äºæ ¹æ®è¿è¡Œæ—¶é—´åˆ›å»ºæ¯ä¸€æ¬¡ä¿å­˜çš„è¿è¡Œæ•°æ®å’Œæœ€åçš„æ¨¡å‹æ–‡ä»¶çš„ run æ–‡ä»¶å¤¹

### tokenizer_loader.py

åŠ è½½æ ¹æ® corpus åˆ›å»ºçš„ .model æ–‡ä»¶ä½œä¸º tokenizer

### data_loader.py

å°† .json æ•°æ®é›†æ ¹æ® tokenizer æ‹†åˆ†ä¸º tokenï¼Œå¹¶åˆ†é… batchï¼ŒåŒæ—¶å‡†å¤‡å¥½ encoder çš„ padding mask å’Œ decoder çš„ padding maskã€ sequence mask

æµç¨‹ï¼š
.json åŸå§‹æ•°æ® -> json.load å¹¶æ ¹æ®æºè¯­è¨€ï¼ˆè‹±è¯­ï¼‰å¥å­é•¿çŸ­æ’åºï¼Œè®©é•¿åº¦ç›¸è¿‘çš„å¥å­åœ¨ä¸€èµ· -> token åŒ–ï¼Œå¹¶æ·»åŠ  BOS EOS æ ‡è®° -> src tgt å¥å­éƒ½è¿›è¡Œ padding ä¿è¯ batch å†…é•¿åº¦ä¸€è‡´ -> decoder çš„è®­ç»ƒè¾“å…¥å»æ‰æœ€åä¸€ä¸ª tokenï¼ˆç”¨ä¸åˆ°ï¼‰, è¾“å‡º label å»æ‰ç¬¬ä¸€ä¸ª tokenï¼ˆç”¨ä¸åˆ°ï¼‰ -> æ·»åŠ  encoder çš„ padding mask å’Œ decoder çš„ padding maskã€ sequence mask

## train_utils.py

å®ç°ä¸Šè¿°æåˆ°çš„ batch å†…åˆ†å—è¿›è¡Œ generator çš„å‰å‘ä¼ æ’­å’Œåå‘ä¼ æ’­ï¼Œå®ç° batch å†…æ‰‹åŠ¨æ¢¯åº¦ç´¯è®¡ï¼Œå‡å°‘æ˜¾å­˜å³°å€¼å ç”¨

## beam_search.py

å®ç°å®Œå…¨çš„è‡ªå›å½’ç”Ÿæˆ

train æ—¶ï¼Œdecoder é¢„æµ‹ä¸‹ä¸€ä¸ª token ä½¿ç”¨çš„è¾“å…¥ï¼Œæ˜¯ label æ•°æ®ã€‚å³ä½¿ä¸Šä¸€è½® token é¢„æµ‹é”™è¯¯äº§ç”Ÿäº†åå·®ï¼Œä¹Ÿä¸ä¼šå‘ç”Ÿé”™è¯¯ç´¯è®¡
val æ—¶ï¼š
1. ä½¿ç”¨åŒæ ·çš„æ–¹æ³•ç»Ÿè®¡ lossã€‚è¿™ä¸»è¦æ˜¯ä¿è¯ loss è®¡ç®—æ–¹å¼ä¸€è‡´æ¥ååº”æ˜¯å¦æ”¶æ•›å’Œè¿‡æ‹Ÿåˆæƒ…å†µ
2. è‡ªå›å½’ç”Ÿæˆï¼Œå®Œå…¨è‡ªå·±ä»å¤´åˆ°å°¾ç”Ÿæˆä¸‹ä¸€ä¸ª tokenï¼Œå­˜åœ¨é”™è¯¯ç´¯è®¡ï¼Œååº”çœŸå®æ€§èƒ½ã€‚è®¡ç®—å¾—åˆ†ä»è€Œä¿å­˜â€œæœ€ä½³â€æ€§èƒ½æ¨¡å‹

## train.py

æ ¸å¿ƒè®­ç»ƒä»£ç 

åˆ›å»º run æ–‡ä»¶å¤¹ -> æ„å»º epochï¼Œæ¯ä¸ª epoch å†…ï¼š(train -> val -> save best model) -> æœ€åè¿›è¡Œ test

## use_model_2_translate.py

ä½¿ç”¨ .pth æ–‡ä»¶è¿›è¡ŒçœŸæ­£çš„ç¿»è¯‘å·¥ä½œã€‚åœ¨ config/config.yaml ä¸­çš„ model_path ä¸­è®¾ç½®